# Pluma

A self-hosted markdown editor with live preview, document encryption, multi-user support, and **multi-organization** capabilities.

## Quick Start

### Prerequisites

- Docker and Docker Compose installed on your system
- Linux, macOS, or Windows with WSL2

### Installation

1. Clone this repository:

   ```bash
   git clone <your-repo-url>
   cd pluma
   ```

2. Run the setup script:

   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```

   This will:
   - Generate secure secrets for JWT and encryption
   - Build the Docker container (frontend + backend in one)
   - Start the application

3. Access the application at **http://localhost:3000**

4. Create your admin account on first visit - this will automatically create your personal organization

## Configuration

If you prefer to set up manually:

1. Generate secrets:

   ```bash
   chmod +x setup-secrets.sh
   ./setup-secrets.sh
   ```

2. Build and start the container:

   ```bash
   docker-compose up -d --build
   ```

3. View logs:
   ```bash
   docker logs pluma -f
   ```

## Configuration

### Docker Secrets

The application uses Docker Secrets for secure credential management:

- `jwt_secret`: Used for JWT token signing (64 hex characters)
- `encryption_key`: Used for document encryption (64 hex characters)

These are automatically generated by `setup-secrets.sh` and stored in the `secrets/` directory.

**⚠️ IMPORTANT:** Never commit the `secrets/` directory to version control. Back up these files securely - losing the encryption key means losing access to encrypted documents.

### Environment Variables

For development without Docker, you can use `.env` file:

```env
JWT_SECRET=your-jwt-secret-here
ENCRYPTION_KEY=your-encryption-key-here
PORT=3001
```

## Backup and Restore

### Automated Backups (Optional)

Enable automated daily backups by starting with the `backup` profile:

```bash
docker-compose --profile backup up -d
```

See [BACKUP.md](BACKUP.md) for detailed backup/restore procedures.

### Manual Backup

Create a one-time backup of all data (documents + database):

```bash
docker run --rm \
  -v pluma_pluma-data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/pluma-backup-$(date +%Y%m%d-%H%M%S).tar.gz -C /data .
```

### Restore from Backup

```bash
docker run --rm \
  -v pluma_pluma-data:/data \
  -v $(pwd)/backups:/backup \
  alpine sh -c "rm -rf /data/* && tar xzf /backup/pluma-backup-YYYYMMDD-HHMMSS.tar.gz -C /data"
```

**⚠️ Important:** Also backup your `secrets/` directory separately! Without these secrets, you cannot decrypt your documents.

## Development

### Local Development

1. Backend:

   ```bash
   cd backend
   npm install
   npm run dev
   ```

2. Frontend (in another terminal):

   ```bash
   cd frontend
   pnpm install
   pnpm dev
   ```

3. Set up environment variables in `backend/.env`:

   ```env
   JWT_SECRET=dev-jwt-secret-key
   ENCRYPTION_KEY=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
   PORT=3001
   DB_PATH=./data/pluma.db
   DOCUMENTS_PATH=./data/documents
   ```

### Lost Encryption Key

If you lose the encryption key, documents cannot be decrypted. Always maintain secure backups of:

- `secrets/encryption_key.txt`
- `secrets/jwt_secret.txt`
- Document data volume

### Regenerating Secrets

⚠️ Warning: This will invalidate all existing encrypted documents and sessions.

```bash
rm -rf secrets/
./setup-secrets.sh
docker-compose down
docker-compose up -d --build
```

## Roadmap

See [FUTURE_FEATURES.md](FUTURE_FEATURES.md) for planned features and improvements.

## Contributing

Contributions are welcome! Please open an issue or submit a pull request.

## License

AGPL-3.0 License. See [LICENSE](LICENSE) for details.
